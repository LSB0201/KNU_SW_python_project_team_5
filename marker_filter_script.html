{% macro html(this, kwargs) %}
<script>
  const markers = __MARKER_DATA__;
  let mapMarkers = [];
  let polylineLayer = null;

  let selectedStartDate = null;
  let selectedEndDate = null;

  const cityCenters = {
    ê²½ì‚°ì‹œ: [35.825, 128.74],
    ê²½ì£¼ì‹œ: [35.856, 129.224],
    êµ¬ë¯¸ì‹œ: [36.12, 128.344],
    ê¹€ì²œì‹œ: [36.139, 128.113],
    ë¬¸ê²½ì‹œ: [36.594, 128.188],
    ìƒì£¼ì‹œ: [36.411, 128.158],
    ì•ˆë™ì‹œ: [36.568, 128.729],
    ì˜ì£¼ì‹œ: [36.805, 128.623],
    ì˜ì²œì‹œ: [35.973, 128.94],
    í¬í•­ì‹œ: [36.019, 129.343],
    ì˜ì„±êµ°: [36.354, 128.697],
    ì¹ ê³¡êµ°: [35.995, 128.41],
    ì²­ì†¡êµ°: [36.435, 129.056],
  };

  function showMarkers(cityName) {
    mapMarkers.forEach((m) => __MAP__.removeLayer(m));
    if (polylineLayer) {
      __MAP__.removeLayer(polylineLayer);
      polylineLayer = null;
    }
    mapMarkers = [];

    let filtered = markers;

    // ì‹œêµ° í•„í„°ë§
    if (cityName && cityName !== "ì „ì²´") {
      filtered = filtered.filter((data) => data.address.includes(cityName));
    }

    // ë‚ ì§œ í•„í„°ë§ (í™”ì¬ë§Œ í•´ë‹¹)
    if (selectedStartDate && selectedEndDate) {
      filtered = filtered.filter((data) => {
        if (data.type === "fire") {
          const reportDate = new Date(data.time);
          return (
            reportDate >= selectedStartDate && reportDate <= selectedEndDate
          );
        }
        return true; // ì†Œë°©ì„œëŠ” ë‚ ì§œ í•„í„° ì œì™¸
      });
    }

    const stationList = markers.filter((m) => m.type === "station");

    filtered.forEach((data) => {
      let icon, popupHtml;

      if (data.type === "fire") {
        icon = L.divIcon({
          className: "",
          html: `<div style="
            background-color: white;
            border: 2px solid red;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            font-size: 22px;
            box-shadow: 1px 1px 5px rgba(255,0,0,0.5);
            user-select: none;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
          ">ğŸ”¥</div>`,
        });
        popupHtml = `ğŸ”¥ í™”ì¬ ë°œìƒ: ${data.address}<br>ğŸ•’ ${data.time}`;
      } else if (data.type === "station") {
        icon = L.divIcon({
          className: "",
          html: `<div style="
            background-color: white;
            border: 2px solid blue;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            font-size: 20px;
            box-shadow: 1px 1px 5px rgba(0,0,255,0.5);
            user-select: none;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
          ">ğŸš’</div>`,
        });
        popupHtml = `ğŸš’ ì†Œë°©ì„œ: ${data.name}<br>ğŸ“ ${data.address}<br>ğŸ“ ${data.phone}`;
      }

      const marker = L.marker([data.lat, data.lng], { icon: icon })
        .addTo(__MAP__)
        .bindPopup(popupHtml);

      // ğŸ”¥ í™”ì¬ ë§ˆì»¤ í´ë¦­ ì‹œ ê°€ì¥ ê°€ê¹Œìš´ ì†Œë°©ì„œ ì ì„  ì—°ê²°
      if (data.type === "fire") {
        marker.on("click", function () {
          if (polylineLayer) {
            __MAP__.removeLayer(polylineLayer);
            polylineLayer = null;
          }

          const fireLatLng = L.latLng(data.lat, data.lng);
          let nearestStation = null;
          let minDist = Infinity;

          stationList.forEach((st) => {
            const dist = fireLatLng.distanceTo([st.lat, st.lng]);
            if (dist < minDist) {
              minDist = dist;
              nearestStation = st;
            }
          });

          if (nearestStation) {
            polylineLayer = L.polyline(
              [fireLatLng, [nearestStation.lat, nearestStation.lng]],
              {
                color: "blue",
                dashArray: "5, 10",
                weight: 3,
              }
            ).addTo(__MAP__);
          }
        });
      }

      mapMarkers.push(marker);
    });

    if (cityName && cityCenters[cityName]) {
      __MAP__.setView(cityCenters[cityName], 11);
    } else {
      __MAP__.setView([35.4, 128.2], 8.3);
    }
  }

  document
    .getElementById("citySelect")
    .addEventListener("change", function (e) {
      const selected = e.target.value;
      showMarkers(selected);
    });

  showMarkers("");
</script>
{% endmacro %}
