{% macro html(this, kwargs) %}
<script>
  const markers = __MARKER_DATA__;
  let mapMarkers = [];

  const cityCenters = {
    경산시: [35.825, 128.74],
    경주시: [35.856, 129.224],
    구미시: [36.12, 128.344],
    김천시: [36.139, 128.113],
    문경시: [36.594, 128.188],
    상주시: [36.411, 128.158],
    안동시: [36.568, 128.729],
    영주시: [36.805, 128.623],
    영천시: [35.973, 128.94],
    포항시: [36.019, 129.343],
    의성군: [36.354, 128.697],
    칠곡군: [35.995, 128.41],
    청송군: [36.435, 129.056],
  };

  function showMarkers(cityName) {
    mapMarkers.forEach((m) => __MAP__.removeLayer(m));
    mapMarkers = [];

    const filtered =
      cityName === "전체" || cityName === ""
        ? markers
        : markers.filter((data) => data.address.includes(cityName));

    filtered.forEach((data) => {
      const icon = L.divIcon({
        className: "",
        html: `<div style="
          background-color: white;
          border: 2px solid red;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          text-align: center;
          line-height: 40px;
          font-size: 22px;
          box-shadow: 1px 1px 5px rgba(255,0,0,0.5);
          user-select: none;
          pointer-events: auto;
          display: flex;
          align-items: center;
          justify-content: center;
        ">🔥</div>`,
      });

      const marker = L.marker([data.lat, data.lng], { icon: icon })
        .addTo(__MAP__)
        .bindPopup(`🔥 화재 발생: ${data.address}<br>🕒 ${data.time}`);
      mapMarkers.push(marker);
    });

    if (cityName && cityCenters[cityName]) {
      __MAP__.setView(cityCenters[cityName], 11);
    } else {
      __MAP__.setView([35.4, 128.2], 8.3);
    }
  }

  document
    .getElementById("citySelect")
    .addEventListener("change", function (e) {
      const selected = e.target.value;
      showMarkers(selected);
    });

  showMarkers("");
</script>
{% endmacro %}
