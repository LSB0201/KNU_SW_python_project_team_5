{% macro html(this, kwargs) %}
<script>
  const markers = __MARKER_DATA__;
  let mapMarkers = [];
  let polylineLayer = null;

  let selectedStartDate = null;
  let selectedEndDate = null;

  const cityCenters = {
    경산시: [35.825, 128.74],
    경주시: [35.856, 129.224],
    구미시: [36.12, 128.344],
    김천시: [36.139, 128.113],
    문경시: [36.594, 128.188],
    상주시: [36.411, 128.158],
    안동시: [36.568, 128.729],
    영주시: [36.805, 128.623],
    영천시: [35.973, 128.94],
    포항시: [36.019, 129.343],
    의성군: [36.354, 128.697],
    칠곡군: [35.995, 128.41],
    청송군: [36.435, 129.056],
  };

  function showMarkers(cityName) {
    mapMarkers.forEach((m) => __MAP__.removeLayer(m));
    if (polylineLayer) {
      __MAP__.removeLayer(polylineLayer);
      polylineLayer = null;
    }
    mapMarkers = [];

    let filtered = markers;

    // 시군 필터링
    if (cityName && cityName !== "전체") {
      filtered = filtered.filter((data) => data.address.includes(cityName));
    }

    // 날짜 필터링 (화재만 해당)
    if (selectedStartDate && selectedEndDate) {
      filtered = filtered.filter((data) => {
        if (data.type === "fire") {
          const reportDate = new Date(data.time);
          return (
            reportDate >= selectedStartDate && reportDate <= selectedEndDate
          );
        }
        return true; // 소방서는 날짜 필터 제외
      });
    }

    const stationList = markers.filter((m) => m.type === "station");

    filtered.forEach((data) => {
      let icon, popupHtml;

      if (data.type === "fire") {
        icon = L.divIcon({
          className: "",
          html: `<div style="
            background-color: white;
            border: 2px solid red;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            font-size: 22px;
            box-shadow: 1px 1px 5px rgba(255,0,0,0.5);
            user-select: none;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
          ">🔥</div>`,
        });
        popupHtml = `🔥 화재 발생: ${data.address}<br>🕒 ${data.time}`;
      } else if (data.type === "station") {
        icon = L.divIcon({
          className: "",
          html: `<div style="
            background-color: white;
            border: 2px solid blue;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            font-size: 20px;
            box-shadow: 1px 1px 5px rgba(0,0,255,0.5);
            user-select: none;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
          ">🚒</div>`,
        });
        popupHtml = `🚒 소방서: ${data.name}<br>📍 ${data.address}<br>📞 ${data.phone}`;
      }

      const marker = L.marker([data.lat, data.lng], { icon: icon })
        .addTo(__MAP__)
        .bindPopup(popupHtml);

      // 🔥 화재 마커 클릭 시 가장 가까운 소방서 점선 연결
      if (data.type === "fire") {
        marker.on("click", function () {
          if (polylineLayer) {
            __MAP__.removeLayer(polylineLayer);
            polylineLayer = null;
          }

          const fireLatLng = L.latLng(data.lat, data.lng);
          let nearestStation = null;
          let minDist = Infinity;

          stationList.forEach((st) => {
            const dist = fireLatLng.distanceTo([st.lat, st.lng]);
            if (dist < minDist) {
              minDist = dist;
              nearestStation = st;
            }
          });

          if (nearestStation) {
            polylineLayer = L.polyline(
              [fireLatLng, [nearestStation.lat, nearestStation.lng]],
              {
                color: "blue",
                dashArray: "5, 10",
                weight: 3,
              }
            ).addTo(__MAP__);
          }
        });
      }

      mapMarkers.push(marker);
    });

    if (cityName && cityCenters[cityName]) {
      __MAP__.setView(cityCenters[cityName], 11);
    } else {
      __MAP__.setView([35.4, 128.2], 8.3);
    }
  }

  document
    .getElementById("citySelect")
    .addEventListener("change", function (e) {
      const selected = e.target.value;
      showMarkers(selected);
    });

  showMarkers("");
</script>
{% endmacro %}
